node {

    stage ('Clone') {
        git url: 'https://github.com/sadheeshkt/autobuild.git'
    }
    cloudfoundry = load "lib/cloudfoundry.groovy"
    shell = load "lib/shell.groovy"
   
    def classesGroovy = load 'Classes.groovy'
     def urlConfig = classesGroovy.URLConfig
    def urlConfigList=[]
    def urlConfigSplit=[]
    def urlList = new File(pwd()+'/autobuild.config') as String[]
    
    for ( item in urlList ) {
      urlConfigSplit=  urlConfig.configSplit(item)
     urlConfigList.add(urlConfig.URLConfigItem(urlConfigSplit[0],urlConfigSplit[1], urlConfigSplit[2]))
     }
  
    urlConfigList.eachWithIndex { item, index ->
     echo "Building project in  "+item.repo+" with url  "+item.url+" using pom.xml file : "+item.pomPath
       
    def mvnHome
    def cfDeployContent
    def hostName 
    stage ('Clone') {
        git url: item.url
    }
    stage('Build') {
         def workspace = pwd()
         def workspacePath= workspace.replace("Program Files (x86)", "PROGRA~2");
         echo 'workspacePath>'+workspacePath
         def pomFile=workspacePath+"/"+item.pomPath
         
         git url : item.url
         mvnHome = tool 'maven3'
         def pom = readMavenPom file: item.pomPath
         echo pom.version
         bat "${mvnHome}/bin/mvn -f $pomFile clean compile package"
         echo '=================================================================================================='
         echo 'final artifact to deploy in cf1' +pwd()
         echo 'final artifact to deploy in cf2' +pom.getArtifactId()
          echo 'final artifact to deploy in cf3' +pom.getArtifactId()
          echo 'final artifact to deploy in cf4' +pom.getVersion()
               echo 'final artifact to deploy in cf4' +pom.getPackaging()
          
          def version=pom.getVersion()
          def artifactId=pom.getArtifactId()
          hostName = "${artifactId}-${version}"
        cfDeployContent=workspacePath+"/"+pom.getArtifactId()+"/target/"+hostName+"."+pom.getPackaging()
          
          echo 'cfDeployContent ' +cfDeployContent
        

     }
      stage('deploy') {
        unstash 'app-artifact'
      

        cloudfoundry.push(artifactId, hostName, cfDeployContent, version, cfSpace, cfOrg, cfApiEndpoint)
        cloudfoundry.mapRoute(artifactId, hostName, cfSpace, cfOrg, cfApiEndpoint)
        }
     
   
     
    }
}
